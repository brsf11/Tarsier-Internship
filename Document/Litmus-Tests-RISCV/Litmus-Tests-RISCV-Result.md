# Litmus-tests-RISCV 测试结果比较
比较硬件和模型执行结果
------------------------------------------

完成上述指令后，你可以将结果与模型进行比较。但不必等到所有测试完成。在上面提到的第二和第三种情况下，可以在 `run.sh` 仍在运行时继续进行指令（即复制现有的 `run.*.log` 文件，并按照上述指示运行 `make merge-hw-tests`）。在第一种情况下，只需在 `make run-hw-tests` 仍在运行时运行 `make merge-hw-tests`。

要将硬件结果与Flat模型进行比较，请执行 `make compare-hw-flat`，要与Herd模型进行比较，请执行 `make compare-hw-herd`。这将显示mcompare的输出，该输出来自diy工具套件，左侧是硬件结果，右侧是模型结果。

如果你在输出的末尾看到 "!!! Warning negative differences in: [...]" 这行，则表示硬件表现出一些模型不允许的行为。这表明硬件与RISC-V RVWMO内存模型不一致。

你最有可能看到的是 "!!! Warning positive differences in: [...]" 这行。这表明模型允许比硬件表现出的更多行为。这是预料之中的，因为实现通常不会像模型允许的那样宽松。此外，测试工具可能没有触发某些行为在硬件上表现出来的正确条件。

Litmus-tests-RISCV 测试结果实例
-------------------------------
Litmus-tests-RISCV 测试结果为log文件，其中包含每一个Litmus测试的结果。如下为一个Litmus测试在QEMU上的测试结果：

```
Thu May 16 13:46:08 2024
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Results for tests/non-mixed-size/HAND/LB+amoadd-data-amoadd.rl+amoadd.aq-data-amoadd.litmus %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
RISCV LB+amoadd-data-amoadd.rl+amoadd.aq-data-amoadd
{
 0:x3=x; 0:x6=y;
 1:x3=y; 1:x6=x;
}
 P0                     | P1                     ;
 ori x2,x0,1            | ori x2,x0,1            ;
 amoadd.w x1,x2,(x3)    | amoadd.w.aq x1,x2,(x3) ;
 xor x4,x1,x1           | xor x4,x1,x1           ;
 ori x4,x4,1            | ori x4,x4,1            ;
 amoadd.w.rl x5,x4,(x6) | amoadd.w x5,x4,(x6)    ;

exists ([x]=2 /\ [y]=2 /\ 0:x1=1 /\ 0:x5=0 /\ 1:x1=1 /\ 1:x5=0)
Generated assembler
#START _litmus_P0
	ori t5,x0,1
	amoadd.w a1,t5,(a5)
	xor t4,a1,a1
	ori t4,t4,1
	amoadd.w.rl a0,t4,(a4)
#START _litmus_P1
	ori t5,x0,1
	amoadd.w.aq a1,t5,(a5)
	xor t4,a1,a1
	ori t4,t4,1
	amoadd.w a0,t4,(a4)
Test LB+amoadd-data-amoadd.rl+amoadd.aq-data-amoadd Allowed
Histogram (3 states)
9748897:>0:x1=1; 0:x5=1; 1:x1=0; 1:x5=0; [x]=2; [y]=2;
523549:>0:x1=0; 0:x5=1; 1:x1=0; 1:x5=1; [x]=2; [y]=2;
9727554:>0:x1=0; 0:x5=0; 1:x1=1; 1:x5=1; [x]=2; [y]=2;
No

Witnesses
Positive: 0, Negative: 20000000
Condition exists ([x]=2 /\ [y]=2 /\ 0:x1=1 /\ 0:x5=0 /\ 1:x1=1 /\ 1:x5=0) is NOT validated
Hash=02c052191eb1538ba909cf6fc7b1ead9
Observation LB+amoadd-data-amoadd.rl+amoadd.aq-data-amoadd Never 0 20000000
Time LB+amoadd-data-amoadd.rl+amoadd.aq-data-amoadd 2.37
```
其中包含该Litmus测试的描述和测试得到的硬件行为

比较结果
--------
使用Litmus-Tests-RISCV自带的比较工具和模型结果，可以比较得出硬件是否满足内存一致性模型。如下为QEMU上运行的结果和自带模型结果比较得到的部分结果：
```
                                                |Kind   | run.log                                                                              flat.logs                                                                            
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
2+2Swap                                         |Allow  | [0:x10=0; 0:x11=0; 1:x10=1; 1:x11=2; [x]=1; [y]=2;]                                  +[0:x10=1; 0:x11=0; 1:x10=1; 1:x11=0; [x]=2; [y]=2;]                                 
                                                |No     | [0:x10=0; 0:x11=2; 1:x10=0; 1:x11=2; [x]=1; [y]=1;]                                                                                                                       
                                                |       | [0:x10=1; 0:x11=2; 1:x10=0; 1:x11=0; [x]=2; [y]=1;]                                                                                                                       
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
2+2Swap+Acqs                                    |Allow  | [0:x10=0; 0:x11=0; 1:x10=1; 1:x11=2; [x]=1; [y]=2;]                                  ==                                                                                   
                                                |No     | [0:x10=0; 0:x11=2; 1:x10=0; 1:x11=2; [x]=1; [y]=1;]                                                                                                                       
                                                |       | [0:x10=1; 0:x11=2; 1:x10=0; 1:x11=0; [x]=2; [y]=1;]                                                                                                                       
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
2+2W                                            |Allow  | [[x]=1; [y]=1;]                                                                      +[[x]=2; [y]=2;]                                                                     
                                                |No     | [[x]=1; [y]=2;]                                                                                                                                                           
                                                |       | [[x]=2; [y]=1;]                                                                                                                                                           
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
2+2W+Swap-fence.r.w-Ws                          |Allow  | [0:x1=1; 1:x1=1;]                                                                    ==                                                                                   
                                                |No     | [0:x1=1; 1:x1=2;]                                                                                                                                                         
                                                |       | [0:x1=2; 1:x1=1;]                                                                                                                                                         
```
第一列为Litmus测试名。第二列为结果类型，即允许或禁止。第三列run.log为硬件执行的结果合计，即硬件上执行得到的所有Litmus结果总和，需注意的是这并不是硬件理论上可能的所有结果，但由于测试执行次数极高，我们可以认为这覆盖了绝大部分甚至所有情况。第四列为模型的结果组合。只要硬件执行结果中没有出现模型不允许的执行结果，我们即认为硬件满足内存一致性模型要求。